- sensor:
##### smart meter ######
  - name: total_consumtion
    unique_id: total_consumtion
    state: >
          {% set wh = states('sensor.smart_meter_positive_wirkenergie_insgesamt') | float(0) %}
          {{ ((wh) / 1000) | round(1, default=0) }}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: total_feed
    unique_id: total_feed
    state: >
          {% set wh = states('sensor.smart_meter_negative_wirkenergie_insgesamt') | float(0) %}
          {{ ((wh) / 1000) | round(1, default=0) }}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: daily_usage
    unique_id: daily_usage
    state: >
          {% set tmp1 = states.var.daily_consumption.state | float(0) %}
          {% set tmp2 = states.sensor.smart_meter_positive_wirkenergie_insgesamt.state | float(0) %}
          {{ tmp2 - tmp1 | round(2, default=0) }}
    state_class: total
    unit_of_measurement: 'Wh'
    device_class: energy

  - name: daily_feed
    unique_id: daily_ufeed
    state: >
          {% set tmp1 = states.var.daily_feed.state | float(0) %}
          {% set tmp2 = states.sensor.smart_meter_negative_wirkenergie_insgesamt.state | float(0) %}
          {{ tmp2 - tmp1 | round(2, default=0) }}
    state_class: total
    unit_of_measurement: 'Wh'
    device_class: energy
    
  - name: taglicher_solarverbrauch
    unique_id: taglicher_solarverbrauch
    state: >
          {{ (states.sensor.hoymiles_hms_800w_t2_ac_daily_energy.state | float(0))  - (states.sensor.daily_feed.state | float(0)) | round(2, default=0)}}
    state_class: total
    unit_of_measurement: 'Wh'
    device_class: energy
    
  - name: stromverbrauch_gesamt_tag
    unique_id: stromverbrauch_gesamt_tag
    state: >
          {{ (states.sensor.taglicher_solarverbrauch.state | float(0))  + (states.sensor.daily_usage.state | float(0)) | round(2, default=0)}}
    state_class: total
    unit_of_measurement: 'Wh'
    device_class: energy
    
  - name: stromverbrauch_gesamt
    unique_id: stromverbrauch_gesamt
    state: >
          {{ (states.sensor.smart_meter_summe_der_aktiven_momentanleistung.state | float(0))  + (states.sensor.hoymiles_hms_800w_t2_ac_power.state | float(0)) | round(2, default=0)}}
    state_class: measurement
    unit_of_measurement: 'W'
    device_class: power
    
  - name: stromverbrauch_gesamt_jahr
    unique_id: stromverbrauch_gesamt_jahr
    state: >
          {{ (states.sensor.total_consumtion.state | float(0))  - (states.input_number.stromverbrauch_start.state | float(0)) | round(2, default=0)}}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: stromverbrauch_gestern_tag
    unique_id: stromverbrauch_gestern_tag
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_taglich', 'last_period') }}

  - name: stromverbrauch_vorherige_woche
    unique_id: stromverbrauch_vorherige_woche
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_wochentlich', 'last_period') }}

  - name: stromverbrauch_vorheriger_monat
    unique_id: stromverbrauch_vorheriger_monat
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_monatlich', 'last_period') }}

  - name: stromverbrauch_netz_gestern_tag
    unique_id: stromverbrauch_netz_gestern_tag
    state_class: total_increasing
    unit_of_measurement: 'Wh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_netz_taglich', 'last_period') }}

  - name: stromverbrauch_netz_vorherige_woche
    unique_id: stromverbrauch_netz_vorherige_woche
    state_class: total_increasing
    unit_of_measurement: 'Wh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_netz_wochentlich', 'last_period') }}

  - name: stromverbrauch_netz_vorheriger_monat
    unique_id: stromverbrauch_netz_vorheriger_monat
    state_class: total_increasing
    unit_of_measurement: 'Wh'
    device_class: energy
    state: > 
          {{ state_attr('sensor.stromverbrauch_netz_monatlich', 'last_period') }}


#####################################################
# WÃ¤rmepumpe
####################################################
  - name: total_consumtion_heat
    unique_id: total_consumtion_heat
    state: >
          {% set wh = states('sensor.smart_meter_energie') | float(0) %}
          {{ ((wh) / 1000) | round(1, default=0) }}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: total_consumtion_heat_ht
    unique_id: total_consumtion_heat_ht
    state: >
          {% set wh = states('sensor.smart_meter_energie_2') | float(0) %}
          {{ ((wh) / 1000) | round(1, default=0) }}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: total_consumtion_heat_nt
    unique_id: total_consumtion_heat_nt
    state: >
          {% set wh = states('sensor.smart_meter_energie_3') | float(0) %}
          {{ ((wh) / 1000) | round(1, default=0) }}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: stromverbrauch_gesamt_waerme_jahr_ht
    unique_id: stromverbrauch_gesamt_waerme_jahr_ht
    state: >
          {{ (states.sensor.total_consumtion_heat_ht.state | float(0))  - (states.input_number.stromverbrauch_ht_start.state | float(0)) | round(2, default=0)}}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: stromverbrauch_gesamt_waerme_jahr_nt
    unique_id: stromverbrauch_gesamt_waerme_jahr_nt
    state: >
          {{ (states.sensor.total_consumtion_heat_nt.state | float(0))  - (states.input_number.stromverbrauch_nt_start.state | float(0)) | round(2, default=0)}}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy

  - name: stromverbrauch_gesamt_waerme_jahr
    unique_id: stromverbrauch_gesamt_waerme_jahr
    state: >
          {{ (states.sensor.stromverbrauch_gesamt_waerme_jahr_ht.state | float(0))  + (states.sensor.stromverbrauch_gesamt_waerme_jahr_nt.state | float(0)) | round(2, default=0)}}
    state_class: total_increasing
    unit_of_measurement: 'kWh'
    device_class: energy